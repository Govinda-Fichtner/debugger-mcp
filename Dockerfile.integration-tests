# Multi-Language Integration Test Docker Image
# Contains Python, Ruby, Node.js, Rust, and Go debuggers for comprehensive testing
#
# Build: docker build -f Dockerfile.integration-tests -t debugger-mcp:integration-tests .
# Run:   docker run --rm -v $(pwd):/workspace debugger-mcp:integration-tests

FROM rust:1.83-slim-bookworm AS base

# Install system dependencies
# Workaround for clock skew: use only main repo, skip security/updates
RUN rm -f /etc/apt/sources.list.d/* && \
    echo "deb http://deb.debian.org/debian bookworm main" > /etc/apt/sources.list && \
    apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    pkg-config \
    libssl-dev \
    python3 \
    python3-pip \
    python3-venv \
    ruby \
    ruby-dev \
    nodejs \
    npm \
    lldb \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install Go 1.21.0 (detect architecture)
ARG GO_VERSION=1.21.0
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ]; then GOARCH="amd64"; \
    elif [ "$ARCH" = "arm64" ]; then GOARCH="arm64"; \
    else echo "Unsupported architecture: $ARCH" && exit 1; fi && \
    curl -L https://go.dev/dl/go${GO_VERSION}.linux-${GOARCH}.tar.gz | tar -C /usr/local -xz
ENV PATH="/usr/local/go/bin:/root/go/bin:${PATH}"

# Install Python debugpy and create python symlink
RUN ln -sf /usr/bin/python3 /usr/bin/python && \
    python3 -m pip install --break-system-packages debugpy

# Install Ruby debug gem
RUN gem install debug

# Install Node.js vscode-js-debug from official tarball
# Tests expect js-debug at /tmp/js-debug/src/dapDebugServer.js
RUN cd /tmp && \
    curl -L https://github.com/microsoft/vscode-js-debug/releases/download/v1.105.0/js-debug-dap-v1.105.0.tar.gz | tar -xzf - && \
    chmod +x /tmp/js-debug/src/dapDebugServer.js

# Note: LLDB is already installed via apt (lldb package)
# rustup lldb component not available on all architectures

# Install Go Delve debugger
RUN go install github.com/go-delve/delve/cmd/dlv@latest

# Note: Skipping cargo-nextest and cargo-tarpaulin due to edition2024 dependency issues
# These tools require Rust 1.86+ which is not yet stable
# We'll use standard cargo test for now (still runs tests in parallel)

# Set working directory
WORKDIR /workspace

# Default command: run all tests including ignored integration tests
# Note: No coverage collection due to cargo-tarpaulin edition2024 dependency
# Skip claude_code_integration test (requires Claude CLI not available in Docker)
CMD ["cargo", "test", "--all", "--", "--include-ignored", "--nocapture", "--skip", "claude_code_integration"]
